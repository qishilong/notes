# workspaces - monorepoå®æˆ˜

## å‰è¨€

npm è‡ªä»v7å¼€å§‹ï¼Œå¼•å…¥äº†ä¸€ä¸ªååˆ†å¼ºå¤§çš„åŠŸèƒ½ï¼Œé‚£å°±æ˜¯`workspaces`ã€‚å¦å¤–ï¼Œyarnå’Œpnpmä¹Ÿæ‹¥æœ‰`workspaces`çš„èƒ½åŠ›ã€‚ä¸è¿‡ï¼Œä»ç”¨æ³•ä¸Šæ¥è¯´ï¼Œå‡ ä¹æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚æ‰€ä»¥ï¼Œå­¦ä¼šäº†npm workspacesçš„è¯ï¼Œè‡ªç„¶è€Œç„¶ä¹Ÿå°±å­¦ä¼šäº†yarnå’Œpnpmçš„äº†ã€‚

## æ¦‚è§ˆ

æœ¬æ–‡ä¼šåˆ†å››ä¸ªéƒ¨åˆ†è¿›è¡Œä»‹ç»ï¼š

1.  ä»€ä¹ˆæ˜¯workspacesï¼›
2.  å¤šåŒ…ç®¡ç†ï¼›
3.  å¤šé¡¹ç›®ç®¡ç†ï¼›
4.  é¿å‘ï¼›
5.  æ€»ç»“ï¼›

## ä»€ä¹ˆæ˜¯workspacesï¼Ÿ

é¡¾åæ€ä¹‰ï¼Œworkspaceså°±æ˜¯å¤šç©ºé—´çš„æ¦‚å¿µï¼Œåœ¨npmä¸­å¯ä»¥ç†è§£ä¸ºå¤šåŒ…ã€‚å®ƒçš„åˆè¡·æ˜¯ä¸ºäº†ç”¨æ¥è¿›è¡Œå¤šåŒ…ç®¡ç†çš„ï¼Œå®ƒå¯ä»¥è®©å¤šä¸ªnpmåŒ…åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸­è¿›è¡Œå¼€å‘å’Œç®¡ç†å˜å¾—éå¸¸æ–¹ä¾¿ï¼š

-   å®ƒä¼šå°†å­åŒ…ä¸­æ‰€æœ‰çš„ä¾èµ–åŒ…éƒ½æå‡åˆ°æ ¹ç›®å½•ä¸­è¿›è¡Œå®‰è£…ï¼Œæå‡åŒ…å®‰è£…çš„é€Ÿåº¦ï¼›
-   å®ƒåˆå§‹åŒ–åä¼šè‡ªåŠ¨å°†å­åŒ…ä¹‹é—´çš„ä¾èµ–è¿›è¡Œå…³è”ï¼ˆè½¯é“¾æ¥ï¼‰ï¼›
-   å› ä¸ºåŒä¸€ä¸ªé¡¹ç›®çš„å…³ç³»ï¼Œä»è€Œå¯ä»¥è®©å„ä¸ªå­åŒ…å…±äº«ä¸€äº›æµç¨‹ï¼Œæ¯”å¦‚ï¼šeslintã€stylelintã€git hooksã€publish flowç­‰ï¼›

è¿™ä¸ªè®¾è®¡æ¨¡å¼æœ€åˆæ¥è‡ªäºLernaï¼Œä½†Lernaå¯¹äºå¤šåŒ…ç®¡ç†ï¼Œæœ‰ç€æ›´å¼ºçš„èƒ½åŠ›ï¼Œè€Œä¸”æœ€æ–°ç‰ˆçš„Lernaå¯ä»¥å®Œå…¨å…¼å®¹npmæˆ–yarnçš„workspacesæ¨¡å¼ã€‚ä¸è¿‡å› ä¸ºæœ¬æ–‡è®²çš„æ˜¯workspacesï¼Œæ‰€ä»¥ï¼Œå¯¹äºLernaæœ‰å…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥è‡ªè¡Œå»[Lernaå®˜ç½‘](https://link.segmentfault.com/?enc=aoTPuuY0ZbiD6PaJy6pSgw%3D%3D.rRr4pHIjc9HwokzljRre6vKDd4udA%2FkWmAQ%2FPyQAkeM%3D)å­¦ä¹ ã€‚

## å¤šåŒ…ç®¡ç†

å¤šåŒ…ç®¡ç†ä¸Šé¢å·²ç»è¯´è¿‡å®ƒç›¸å¯¹å•åŒ…å•ç‹¬ç®¡ç†çš„å¥½å¤„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬é€šè¿‡å®ä¾‹çš„ä¾‹å­æ¥è®©åŒå­¦ä»¬æ„Ÿå—ä¸€ä¸‹workspacesä¸ºä»€ä¹ˆè¢«æˆ‘å¹çš„è¿™ä¹ˆç‰›æ‰¹ã€‚

### ä¾‹å­æ¼”ç¤º

é¡¹ç›®åœ°å€æˆ‘æŒ‚åœ¨githubä¸Šäº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹[æºç ](https://link.segmentfault.com/?enc=PKlPZmG3drf83h78SaYM0Q%3D%3D.WzyaOJIpIGzBwvvBBRoD6HXZc7EfcxDauHqxU5SIlxEjgb6choPEIk5kI5azc8SnJJl0pPrEf8lMwnMtg3P%2Fkfor%2BYsqb47Id14RMibKXms%3D)ã€‚

#### 1. å‡çº§npmåˆ°7æˆ–æœ€æ–°ç‰ˆ

```shell
npm i -g npm@latest
```

#### 2. åˆ›å»ºé¡¹ç›®

```shell
mkdir demo-workspaces-multi-packages
```

#### 3. åˆå§‹åŒ–é¡¹ç›®

```shell
npm init -y
.
â””â”€â”€ package.json
```

#### 4. å£°æ˜æœ¬é¡¹ç›®æ˜¯workspacesæ¨¡å¼

`package.json`æ–°å¢é…ç½®ï¼š

```json
"private":"true",
"workspaces": [
  "packages/*"
],
```

è¿™é‡Œçš„`packages/*`è¡¨ç¤ºæˆ‘ä»¬çš„å­åŒ…éƒ½åœ¨`packages`æ–‡ä»¶å¤¹ä¸‹ã€‚ï¼ˆå¯¹äºworkspacesçš„ç»†èŠ‚å’Œæ›´å¤šç”¨æ³•æœ¬æ–‡ä¸ä¼šä¸€ä¸€ä»‹ç»ï¼Œæ–‡æ¡£éå¸¸æ¸…æ¥šï¼Œæœ¬æ–‡è®²ç©¶å®æˆ˜ï¼‰

#### 5. åˆå§‹åŒ–å­åŒ…`m1`

åˆ›å»ºå­åŒ…`m1`ï¼š

```shell
npm init -w packages/m1 -y
.
â”œâ”€â”€ package.json
â””â”€â”€ packages
    â””â”€â”€ m1
        â””â”€â”€ package.json
```

åˆ›å»º`m1`çš„ä¸»æ–‡ä»¶`index.js`ï¼š

```shell
echo "exports.name = 'kitty'" >> packages/m1/index.js
.
â”œâ”€â”€ package.json
â””â”€â”€ packages
    â””â”€â”€ m1
        â”œâ”€â”€ index.js
        â””â”€â”€ package.json
```

#### 6. åˆå§‹åŒ–å­åŒ…`m2`

åŒæ ·çš„æ–¹å¼ï¼Œåˆ›å»ºå­åŒ…`m2`ï¼š

```shell
npm init -w packages/m2 -y
.
â”œâ”€â”€ package.json
â””â”€â”€ packages
    â”œâ”€â”€ m1
    â”‚   â”œâ”€â”€ index.js
    â”‚   â””â”€â”€ package.json
    â””â”€â”€ m2
        â””â”€â”€ package.json
```

åˆ›å»º`m2`çš„ä¸»æ–‡ä»¶`index.js`ï¼š

```shell
echo "const { name } = require('m1')\nexports.name = name" >> packages/m2/index.js
.
â”œâ”€â”€ package.json
â””â”€â”€ packages
    â”œâ”€â”€ m1
    â”‚   â”œâ”€â”€ index.js
    â”‚   â””â”€â”€ package.json
    â””â”€â”€ m2
        â”œâ”€â”€ index.js
        â””â”€â”€ package.json
```

å› ä¸ºè¿™é‡Œ`require('m1')`ï¼Œæ‰€ä»¥éœ€è¦æ·»åŠ `m1`ä¾èµ–åˆ°`m2`çš„`package.json`ä¸­ï¼š

```shell
npm i -S m1 --workspace=m2
```

#### 7. åˆå§‹åŒ–å­åŒ…`demo`

ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬çœ‹åˆ°æ•ˆæœï¼Œå†åˆ›å»ºä¸€ä¸ª`demo`æ–‡ä»¶å¤¹ï¼ˆå¤šåŒ…ç®¡ç†æ¨èæä¸ªdemoå­åŒ…è¿›è¡Œæ•´ä½“æ•ˆæœæµ‹è¯•ï¼‰ï¼š

```shell
npm init -w packages/demo -y
echo "const { name } = require('m2')\nconsole.log(name)" >> packages/demo/index.js
.
â”œâ”€â”€ package.json
â””â”€â”€ packages
    â”œâ”€â”€ demo
    â”‚   â”œâ”€â”€ index.js
    â”‚   â””â”€â”€ package.json
    â”œâ”€â”€ m1
    â”‚   â”œâ”€â”€ index.js
    â”‚   â””â”€â”€ package.json
    â””â”€â”€ m2
        â”œâ”€â”€ index.js
        â””â”€â”€ package.json
```

é¢å¤–çš„ï¼Œè¿™ä¸ªdemoåŒ…ï¼Œæˆ‘ä»¬å¹¶ä¸åƒä»–è¿›è¡Œå‘å¸ƒï¼Œä¸ºäº†é˜²æ­¢ä¸å°å¿ƒå‘å¸ƒï¼Œæˆ‘ä»¬åœ¨`demo`çš„`package.json`ä¸­æ–°å¢ï¼š

```json
"private":"true",
```

å› ä¸ºè¿™é‡Œ`require('m2')`ï¼Œæ‰€ä»¥éœ€è¦æ·»åŠ `m2`ä¾èµ–åˆ°`demo`çš„`package.json`ä¸­ï¼š

```shell
npm i -S m2 --workspace=demo
```

æˆ‘ä»¬çœ‹çœ‹è¿™æ—¶å€™é¡¹ç›®æ ¹ç›®å½•çš„`node_modules`å§ï¼š
<img width="300px" src="https://qiniucloud.qishilong.space/images/148692468-e94beeca-3205-40f9-9e2b-b4c145a2f4a4.png">
æ˜¯ä¸æ˜¯å¾ˆæœ‰æ„æ€ï¼Ÿå…¨æ˜¯è½¯é“¾æ¥ï¼Œé“¾æ¥çš„æŒ‡å‘å°±æ˜¯`packages`æ–‡ä»¶å¤¹ä¸‹çš„å„å­åŒ…ã€‚

OKï¼Œæäº†åŠå¤©ï¼Œæˆ‘ä»¬è¿è¡Œ`demo`çœ‹ä¸‹æ•ˆæœå§ï¼š

```shell
node packages/demo/index.js
# è¾“å‡ºï¼š
kitty
```

é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œ`workspaces`å¯¹äºæœ¬åœ°å­åŒ…ä¹‹é—´çš„ä¾èµ–å¤„ç†çš„éå¸¸å·§å¦™ï¼Œä¹Ÿè®©å¼€å‘è€…æ›´åŠ æ–¹ä¾¿ï¼Œå°¤å…¶æ˜¯å¤šäººå¼€å‘çš„æ—¶å€™ã€‚å¦ä¸€ä¸ªäººåœ¨æ‹‰å–å®Œé¡¹ç›®ä»¥åï¼Œåªéœ€è¦è¿è¡Œ`npm install`ï¼Œå³å¯è¿›è¡Œå¼€å‘ï¼Œè½¯é“¾æ¥ä¼šè‡ªåŠ¨å»ºç«‹å¥½ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹`workspaces`é¡¹ç›®ä¸­å¦‚æœå®‰è£…ä¸‰æ–¹åŒ…çš„æƒ…å†µã€‚

#### 8. å®‰è£…ä¸¤ä¸ªä¸åŒç‰ˆæœ¬çš„åŒ…

```shell
npm i -S vue@2 --workspace=m1
npm i -S vue@3 --workspace=m2
```

ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æƒ³çœ‹çœ‹ï¼Œå› ä¸ºæˆ‘ä»¬çš„åŒ…éƒ½ä¼šè¢«æå‡åˆ°æ ¹ç›®å½•è¿›è¡Œå®‰è£…ï¼Œé‚£ä¹ˆä¸åŒç‰ˆæœ¬çš„`vue`å®ƒä¼šæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿéš¾é“åªä¼šå®‰è£…`vue3`çš„åŒ…å—ï¼Ÿ

ç»“æœï¼š
<img width="300px" src="https://qiniucloud.qishilong.space/images/148693126-3426d7b8-a011-4634-87e4-e1e52e5c798b.png">
è¿™æ ·ï¼Œæˆ‘ä»¬å°±æ— éœ€æ‹…å¿ƒç‰ˆæœ¬å†²çªçš„é—®é¢˜äº†ï¼Œ`workspaces`æ˜¾ç„¶å·²ç»å¾ˆå¥½åœ°è§£å†³äº†ã€‚

#### é‡ç‚¹å‚æ•°`--workspace`

åœ¨`workspaces`é¡¹ç›®ä¸­ï¼Œä¸€ä¸ªå¾ˆæ ¸å¿ƒçš„å‚æ•°å°±æ˜¯`--workspace`ï¼Œå› ä¸ºä»å‰æ–‡çš„å®‰è£…åŒ…åˆ°å­åŒ…çš„å‘½ä»¤å¯ä»¥å‘ç°ï¼Œå’Œä¼ ç»Ÿçš„å®‰è£…åŒ…ä¸€æ ·ï¼Œéƒ½æ˜¯ä½¿ç”¨`npm i -S åŒ…å`æˆ–è€…`npm i -D åŒ…å`ï¼Œä¸åŒçš„ä»…ä»…æ˜¯æœ«å°¾åŠ äº†`--workspace`ã€‚

é‚£æ˜¯ä¸æ˜¯å¯¹äºå…¶å®ƒçš„å‘½ä»¤ï¼Œæ¯”å¦‚`run`ã€`version`ã€`publish`ç­‰ä¹Ÿæ˜¯æ ·çš„ä½¿ç”¨æ–¹å¼å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼šYesï¼

å¦å¤–ï¼Œå¦‚æœæˆ‘ä»¬å­åŒ…çš„`package.json`ä¸­`scprits`å…¨éƒ½æœ‰ä¸€ä¸ªå«`test`çš„å‘½ä»¤ï¼Œæˆ‘ä»¬æƒ³ä¸€æ¬¡æ€§è¿è¡Œæ‰€æœ‰å­åŒ…çš„è¿™ä¸ªå‘½ä»¤ï¼Œå¯ä»¥ä½¿ç”¨`npm run test --workspaces`å³å¯ã€‚
è¿™æ ·çš„è¯ï¼Œå¯¹äºæˆ‘ä»¬çš„**Lintæ ¡éªŒ**æˆ–æ˜¯**å•æµ‹**éƒ½æ˜¯éå¸¸æ–¹ä¾¿çš„ã€‚

åˆ°æ­¤ï¼Œworkspacesåœ¨å¤šåŒ…ç®¡ç†ä¸­å¯åˆ°çš„ä½œç”¨å°±åŸºæœ¬ä»‹ç»å®Œäº†ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå¤šåŒ…ç®¡ç†ï¼Œå®é™…é¡¹ç›®ä¸­è¿˜æ˜¯æ¨èä½¿ç”¨`Lerna`ï¼Œå®ƒå¯¹äºç‰ˆæœ¬ä¾èµ–è‡ªåŠ¨å‡çº§ã€å‘åŒ…æç¤ºã€è‡ªåŠ¨ç”ŸæˆLogï¼ˆChange Log / Release Noteï¼‰ã€CIç­‰éƒ½å…·æœ‰ä¸€å¥—ååˆ†æˆç†Ÿçš„æµç¨‹æœºåˆ¶äº†ã€‚

## å¤šé¡¹ç›®ç®¡ç†

ç›®å‰çš„npm`workspaces`ï¼Œä¸ªäººè®¤ä¸ºæ˜¯éå¸¸é€‚åˆç”¨æ¥åšå¤šé¡¹ç›®çš„æ•´åˆï¼ˆMonorepoï¼‰ç®¡ç†çš„ ã€‚

### ä¾‹å­æ¼”ç¤º

é¡¹ç›®åœ°å€æˆ‘æŒ‚åœ¨githubä¸Šäº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹[æºç ](https://link.segmentfault.com/?enc=ptrBDGkHzyPLaUVN97ujdQ%3D%3D.njzfRkCdgt4PD84EgRw5MO%2Bkq6m1lBonTERWxsdEeLZocF1S%2FNevbH3rDms4a%2Fen%2BA8Iv9%2BqgCgWY%2BD0MV7n9sYXsbfqj7fFF0a7kVOBzF8%3D)ã€‚

#### 1. åˆ›å»ºé¡¹ç›®

```shell
mkdir demo-workspaces-multi-project
```

#### 2. åˆå§‹åŒ–é¡¹ç›®

```shell
npm init -y
.
â””â”€â”€ package.json
```

#### 3. å£°æ˜æœ¬é¡¹ç›®æ˜¯workspacesæ¨¡å¼

`package.json`æ–°å¢é…ç½®ï¼š

```json
"private":"true",
"workspaces": [
  "projects/*"
],
```

#### 4. åˆå§‹åŒ–å­é¡¹ç›®`zoo`

åˆ›å»ºå­é¡¹ç›®`zoo`ï¼š

```shell
npm init -w projects/zoo -y
.
â”œâ”€â”€ package.json
â””â”€â”€ packages
    â””â”€â”€ zoo
        â””â”€â”€ package.json
```

åˆ›å»ºæ¨¡æ¿æ–‡ä»¶`index.html`ï¼Œä¸»å†…å®¹ä¸ºï¼š

```xml
<!-- projects/zoo/index.html -->
<body>
  <h1>Welcome to Zoo!</h1>
  <div id="app"></div>
</body>
```

åˆ›å»ºé¡¹ç›®å…¥å£jsæ–‡ä»¶`index.js`ï¼Œå†…å®¹ä¸ºï¼š

```javascript
console.log('Zoo')
```

å®‰è£…é¡¹ç›®æ„å»ºä¾èµ–åŒ…ï¼š

```shell
npm i -S webpack webpack-cli webpack-dev-server html-webpack-plugin webpack-merge --workspace=zoo

# projects/zoo/package.json
"private":"true",
"dependencies": {
  "html-webpack-plugin": "^5.5.0",
  "webpack": "^5.65.0",
  "webpack-cli": "^4.9.1",
  "webpack-dev-server": "^4.7.2"
}
```

åˆ›å»ºwebpacké…ç½®ï¼š

```javascript
// projects/zoo/webpack/base.config.js
const HtmlWebpackPlugin = require('html-webpack-plugin')
const path = require('path')

function resolve(dir) {
  return path.join(__dirname, '../' + dir)
}

exports.config = {
  entry: resolve('src/index.js'),

  plugins: [
    new HtmlWebpackPlugin({
      title: 'Zoo',
      filename: 'index.html',
      template: resolve('src/index.html')
    })
  ],
}

exports.resolve = resolve
// projects/zoo/webpack/dev.config.js
const { config, resolve } = require('./base.config')
const { merge } = require('webpack-merge')

exports.default = merge(config, {
  mode: 'development',

  output: {
    filename: 'bundle.js',
  },
})
// projects/zoo/webpack/prod.config.js
const { config, resolve } = require('./base.config')
const { merge } = require('webpack-merge')

exports.default = merge(config, {
  mode: 'production',

  output: {
    filename: 'bundle.js',
  },
})
```

zooä¸‹çš„`package.json`æ–°å¢å‘½ä»¤ï¼š

```javascript
"scripts": {
  "dev": "webpack-dev-server --config webpack/dev.config.js --open",
  "prod": "webpack --config webpack/prod.config.js"
},
```

æ¥ä¸‹æ¥å°±å¯ä»¥è¿è¡Œäº†ï¼Œåªéœ€è¦åœ¨é¡¹ç›®æ ¹ç›®å½•ä½¿ç”¨ï¼š

```shell
npm run dev --workspace=zoo
```

å³å¯è¿›è¡Œæœ¬åœ°å¼€å‘ã€‚

æ•ˆæœï¼š
<img width="200px" src="https://qiniucloud.qishilong.space/images/148756703-5d1a71e7-ecf3-4d56-947d-2a8ad2f2c4d1.png">

è¿è¡ŒprodåŒç†ã€‚

#### 5. åˆå§‹åŒ–å­é¡¹ç›®`shop`

åˆ›å»ºå­é¡¹ç›®`shop`ï¼š

```shell
npm init -w projects/shop -y
```

å…¶ä½™æ­¥éª¤åŒåˆå§‹åŒ–å­é¡¹ç›®`zoo`å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œæ‰€ä»¥ä¸å†èµ˜è¿°ã€‚

æœ€åçš„ç›®å½•ç»“æ„ï¼š
<img width="150px" src="https://qiniucloud.qishilong.space/images/148758564-84a086c0-caf1-4042-b6e7-d0e232787490.png">

### å…±äº«

å¯¹äºMonorepoï¼Œå…±äº«æ˜¯æœ€é‡è¦çš„ä¸€ä¸ªä¼˜åŠ¿ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æ¥åšä¸€äº›å…±äº«çš„äº‹æƒ…ã€‚

#### 1. åœ¨æ ¹ç›®å½•åˆ›å»º`share`æ–‡ä»¶å¤¹ï¼Œä½œä¸ºå…±äº«èµ„æºç›®å½•ï¼Œå¹¶åˆ›å»ºå…±äº«æ–‡ä»¶`Fish.js`ï¼š

```shell
mkdir share
mkdir share/js
touch share/js/Fish.js
// share/js/Fish.js
class Fish {
  constructor(name, age) {
    this.name = name
    this.age = age
  }

  swim() {
    console.log('swim~')
  }

  print() {
    return 'ğŸŸ '
  }
}

module.exports = Fish
```

#### 2. å­é¡¹ç›®ä¸­çš„`webpack`é…ç½®æ–°å¢`alias`

å­é¡¹ç›®`zoo`å’Œ`shop`éƒ½åŠ ä¸Šç›¸åŒçš„`alias`å³å¯ï¼š

```javascript
resolve: {
  extensions: ['.js'],
  alias: {
    '$share': resolve('../../share'),
  },
},
```

å­é¡¹ç›®`zoo`çš„å…¥å£æ–‡ä»¶æ”¹ä¸ºï¼š

```javascript
// projects/zoo/src/index.js
const Fish = require('$share/js/Fish')
const fish = new Fish()
document.getElementById('app').textContent = fish.print()
```

è¿è¡Œ`zoo`çš„`dev`çœ‹æ•ˆæœï¼š
<img width="150px" src="https://qiniucloud.qishilong.space/images/148770309-3fe66464-6b1e-4780-948b-6873ee4cab5e.png">

ä¿®æ”¹å­é¡¹ç›®`shop`çš„å…¥å£æ–‡ä»¶åï¼Œä¼šå‡ºç°åŒæ ·çš„æ•ˆæœã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œshareæ–‡ä»¶å¤¹ä¸‹çš„ä¸œè¥¿ï¼Œ`zoo`å’Œ`shop`å¯ä»¥å…¬ç”¨äº†ï¼Œéœ€è¦åšçš„ä»…ä»…æ˜¯æ–°å¢ä¸€ä¸ªwebpackçš„`alias`è€Œå·²ï¼ğŸ‰

### ğŸ¤”æ€è€ƒ â€”â€” æˆ‘ä»¬ä¸ºä»€ä¹ˆä½¿ç”¨`workspaces`åšé›†åˆé¡¹ç›®ï¼Œç”¨ä¼ ç»Ÿæ–¹å¼ä¸è¡Œå—ï¼Ÿ

ä¼ ç»Ÿæ–¹å¼ï¼š

1.  å„ä¸ªå­é¡¹ç›®éƒ½é›†åˆåˆ°ä¸€ä¸ªé¡¹ç›®ä¸­æ¥ã€‚å’Œä¸Šæ–‡ä¸åŒçš„æ˜¯ï¼Œ`package.json`åªæœ‰ä¸€ä»½ï¼Œåœ¨æ ¹ç›®å½•ï¼Œæ‰€æœ‰é¡¹ç›®ä¸­çš„npmåŒ…éƒ½å®‰è£…åˆ°æ ¹ç›®å½•ï¼Œåœ¨æ ¹ç›®å½•çš„`package.json`ä¸­å®šä¹‰**å¼€å‘**å’Œ**éƒ¨ç½²**å­é¡¹ç›®çš„å‘½ä»¤ï¼›
2.  å„ä¸ªå­é¡¹ç›®éƒ½é›†åˆåˆ°ä¸€ä¸ªé¡¹ç›®ä¸­æ¥ã€‚å’Œä¸Šæ–‡ä¸åŒçš„æ˜¯ï¼Œè™½ç„¶æ ¹ç›®å½•å’Œå„ä¸ªå­åŒ…éƒ½å„è‡ªæœ‰ä¸€ä»½`package.json`ï¼Œä½†åŸºç¡€çš„æ„å»ºå·¥å…·åœ¨æ ¹ç›®å½•è¿›è¡Œå®‰è£…ï¼Œæ¯”å¦‚ä¸Šé¢æåˆ°çš„`webpack`ã€`webpack-cli`ã€`webpack-dev-server`ã€`html-webpack-plugin`ã€`webpack-merge`ï¼Œå…¨éƒ½åœ¨æ ¹ç›®å½•è¿›è¡Œå®‰è£…ï¼Œå’Œä¸šåŠ¡ç›¸å…³çš„npmåŒ…éƒ½å®‰è£…åˆ°å„è‡ªå­é¡¹ç›®ä¸­ï¼›
3.  å„ä¸ªå­é¡¹ç›®éƒ½é›†åˆåˆ°ä¸€ä¸ªé¡¹ç›®ä¸­æ¥ã€‚å’Œä¸Šæ–‡ä¸åŒçš„æ˜¯ï¼Œå„ä¸ªå­åŒ…éƒ½å„è‡ªæœ‰ä¸€ä»½`package.json`ï¼Œæ ¹ç›®å½•æ— `package.json`ï¼›

æ–¹å¼1 â€”â€” ç¼ºç‚¹ï¼š

-   å‘½ä»¤æ··ä¹±ï¼›
-   æ— æ³•åº”å¯¹å­é¡¹ç›®ä¹‹é—´å­˜åœ¨npmåŒ…å†²çªçš„é—®é¢˜ï¼›ï¼ˆæ¯”å¦‚ï¼ŒAé¡¹ç›®æƒ³ç”¨webpack4ï¼ŒBé¡¹ç›®æƒ³ç”¨webpack5ï¼›æˆ–è€…Aé¡¹ç›®æƒ³ç”¨Vue2ï¼Œè€ŒBé¡¹ç›®æƒ³ç”¨Vue3ï¼‰

æ–¹å¼2 â€”â€” ç¼ºç‚¹ï¼š

-   å¦‚æœå­é¡¹ç›®æœ‰ç›¸åŒçš„åŒ…ï¼Œä¸å¾—ä¸åœ¨å„ä¸ªå­é¡¹ç›®ä¸­é‡å¤å®‰è£…ï¼›
-   åŒæ ·æ— æ³•åº”å¯¹å­é¡¹ç›®ä¹‹é—´å­˜åœ¨npmåŒ…å†²çªçš„é—®é¢˜ï¼›ï¼ˆæ¯”å¦‚ï¼ŒAé¡¹ç›®æƒ³ç”¨webpack4ï¼ŒBé¡¹ç›®æƒ³ç”¨webpack5ï¼‰
-   å¦‚æœæŸå¤©æƒ³æŠŠBé¡¹ç›®ç§»é™¤ï¼Œæˆæœ¬å¾ˆé«˜ï¼›

æ–¹å¼3 â€”â€” ç¼ºç‚¹ï¼š

-   å¦‚æœå­é¡¹ç›®æœ‰ç›¸åŒçš„åŒ…ï¼Œä¸å¾—ä¸åœ¨å„ä¸ªå­é¡¹ç›®ä¸­é‡å¤å®‰è£…ï¼›

é‚£ä½¿ç”¨`workspaces`å°±å¾ˆå¥½çš„è§£å†³äº†ä¸Šé¢çš„æ‰€æœ‰é—®é¢˜ï¼

å¦å¤–ï¼Œå¯¹äºå·²ç»å­˜åœ¨çš„é¡¹ç›®è€Œè¨€ï¼Œæ¯”å¦‚æˆ‘ä»Šå¹´æ‰€æ¥æ‰‹çš„é¡¹ç›®ï¼Œä¸€ä¸ªæ˜¯Webçš„ï¼Œä¸€ä¸ªæ˜¯Wapçš„ï¼Œç„¶åå‘ç°ï¼Œå› ä¸ºä»–ä»¬å±äºåŒä¸€ä¸ªä¸šåŠ¡ï¼Œæ‰€ä»¥æœ‰å¤§é‡çš„ä»£ç å¯ä»¥å¤ç”¨ï¼Œåˆå› ä¸ºåªæ¶‰åŠè¿™ä¸¤ä¸ªé¡¹ç›®è€Œå·²ï¼ŒæŠŠå…¬å…±ä»£ç åšæˆnpmåŒ…åˆæœ‰ç‚¹å¤ªæ€é¸¡ç”¨ç‰›åˆ€ï¼Œæ‰€ä»¥ï¼Œè¿‡å»ä¸€ç›´é‡‡ç”¨çš„æ˜¯å¤åˆ¶ã€ç²˜è´´çš„æ¨¡å¼ã€‚è¿™æ˜¾ç„¶æ˜¯éå¸¸ä½æ•ˆçš„ã€‚å¦å¤–å°±æ˜¯ï¼ŒmockæœåŠ¡ä¹Ÿæ˜¯ä¸ªå­—é¡¹ç›®å•ç‹¬ä¸€å¥—ï¼Œä½†æ˜¯å¤§å¤šæ•°æ¥å£çš„æ•°æ®éƒ½æ˜¯å¯ä»¥å…¬ç”¨çš„ï¼Œåªæ˜¯urlå‰ç¼€ä¸åŒã€‚æœ€ç¦»è°±çš„å°±æ˜¯å‡ ç™¾ä¸ªé“¶è¡Œå›¾æ ‡éƒ½ä¸€æ¨¡ä¸€æ ·ã€‚æ‰€ä»¥ï¼Œæˆ‘æ‰“ç®—å°†å®ƒä¿©åˆå¹¶æˆä¸€ä¸ªé¡¹ç›®ã€‚è€Œ`workspaces`å¯¹äºæˆ‘æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªå¯¹åŸé¡¹ç›®æ”¹åŠ¨é‡æœ€å°çš„æ–¹æ¡ˆã€‚

### æ€ä¹ˆå•ç‹¬éƒ¨ç½²ï¼Ÿ

æˆ‘ä»¬æƒ³è¦åœ¨æ„å»ºæœºä¸Šåªéƒ¨ç½²é¡¹ç›®`zoo`ï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ

#### 1. å®‰è£…ä¾èµ–åŒ…

```javascript
npm install --production --workspace=zoo 
```

è¿™æ ·çš„è¯ï¼Œæ„å»ºæœºä¸Šå°±åªä¼šå®‰è£…`zoo`é¡¹ç›®ä¸‹çš„ä¾èµ–åŒ…äº†ã€‚

#### 2. æ„å»º

```javascript
npm run prod --workspace=zoo 
```

è¿™æ ·çš„è¯ï¼Œå°±æ„å»ºæˆåŠŸäº†ï¼

## é¿å‘

npmçš„workspaceså…¶å®æœ‰éšè—çš„å‘ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿç½—åˆ—ä¸‹ã€‚

### å‘ä¸€ï¼šnpm install é»˜è®¤æ¨¡å¼çš„å‘

npm v7å¼€å§‹ï¼Œinstallä¼šé»˜è®¤å®‰è£…ä¾èµ–åŒ…ä¸­çš„`peerDependencies`å£°æ˜çš„åŒ…ã€‚æ–°é¡¹ç›®å¯èƒ½å½±å“ä¸å¤§ï¼Œä½†æ˜¯ï¼Œå¦‚æœä½ æ˜¯æ”¹é€ ç°æœ‰çš„é¡¹ç›®ã€‚å› ä¸ºç”¨äº†ç»Ÿä¸€ç®¡ç†çš„æ–¹å¼ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½ä¼šæŠŠå­é¡¹ç›®ä¸­çš„lockæ–‡ä»¶åˆ æ‰ï¼Œåœ¨æ ¹ç›®å½•ç”¨ç»Ÿä¸€çš„lockç®¡ç†ã€‚ç„¶åï¼Œå½“ä½ è¿™ä¹ˆåšäº†ä»¥åï¼Œå¯èƒ½å‘çˆ¹çš„äº‹æƒ…å°±å‡ºç°äº†ã€‚
åœºæ™¯ï¼šæˆ‘çš„å­é¡¹ç›®ä¸­ç”¨çš„æ˜¯`webpack4`ï¼Œç„¶åï¼Œæˆ‘ä»¬çš„æ„å»ºç›¸å…³çš„å·¥å…·ï¼ˆwebpackã€babelã€postcssã€eslintã€stylintç­‰ï¼‰éƒ½ä¼šå°è£…åˆ°åŸºç¡€åŒ…ä¸­ã€‚è¿™äº›åŒ…çš„ä¾èµ–åŒ…ä¸­æœ‰ä¸€ä¸ªåŒ…ï¼Œåœ¨`package.json`å£°æ˜ä¸­ä½¿ç”¨è¿™æ ·å†™ï¼š

```json
"peerDependencies": {
  "webpack": "^5.1.0"
},
```

ç„¶åï¼Œåœ¨æ ¹ç›®å½•ä¸­`npm install`ï¼Œç„¶åå†è·‘å­é¡¹ç›®å‘ç°é¡¹ç›®è·‘ä¸èµ·æ¥äº†ã€‚åŸå› å°±æ˜¯ï¼Œé¡¹ç›®å±…ç„¶å®‰è£…çš„æ˜¯`webpack5`çš„ç‰ˆæœ¬ï¼

#### è§£å†³æ–¹æ¡ˆ

-   æ–¹æ¡ˆ1ï¼šåœ¨å­é¡¹ç›®çš„`package.json`ä¸­æ˜¾ç¤ºå£°æ˜ç”¨çš„`webpack`ç‰ˆæœ¬ï¼›
-   æ–¹æ¡ˆ2ï¼šå»githubå’Œä½œè€…å•†é‡ä¿®å¤ä¾èµ–åŒ…ï¼Œå¦‚æœä»–çš„åŒ…å³å…¼å®¹`webpack4`ä¹Ÿå…¼å®¹`webpack5`ï¼Œåº”è¯¥å†™æˆï¼ŒæŠŠå£°æ˜æ”¹ä¸ºï¼š` "webpack": "^4.0.0 || ^5.0.0"`
-   æ–¹æ¡ˆ3ï¼š`npm install --legacy-peer-deps`

ä¸ªäººçœŸçš„è§‰å¾—è¿™æ˜¯npmä½œè€…è„‘è¢‹è¢«é©´è¸¢äº†ã€‚å¯¹äºyarnæˆ–è€…pnpmï¼Œä»–ä»¬çš„`workspaces`éƒ½ä¸ä¼šç”¨è¿™ç§é»˜è®¤å®‰è£…`peerDependencies`çš„æ¨¡å¼ã€‚
ä½œè€…åŸæœ¬æ˜¯æƒ³ï¼Œå› ä¸ºå¦‚æœnpmåŒ…çš„å¼€å‘è€…å£°æ˜äº†`peerDependencies`ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨è¿‡ç¨‹ä¸­æ²¡æœ‰å®‰è£…åŒ¹é…çš„ç‰ˆæœ¬çš„åŒ…å°±å¯èƒ½å¯¼è‡´é¡¹ç›®è·‘ä¸äº†ï¼Œä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œä»–å°±é‡‡ç”¨äº†é»˜è®¤å®‰è£…çš„æ¨¡å¼ã€‚
ä½†æ˜¯ï¼Œè¿™ç§åšæ³•ä¼šå¯¼è‡´é‚£äº›`peerDependencies`ä¸ç¬¦åˆä¹¦å†™è§„èŒƒçš„åŒ…ï¼Œåœ¨é¡¹ç›®ä¸­é…åˆä½¿ç”¨å‡ºç°é—®é¢˜ã€‚è€Œä¸”ï¼Œå³ä½¿æ–°çš„åŒ…ä¸­åŒ…ä½œè€…ä»¬å¼€å§‹æ³¨æ„ä¹¦å†™è§„èŒƒï¼Œä½†æ˜¯æ— æ³•å¤„ç†é‚£äº›å·²ç»å‘å¸ƒå‡ºå»çš„è€åŒ…ï¼Œæ€»ä¸å¯èƒ½å…¨éƒ½å›æ”¶ï¼Œç„¶åä¸€ä¸ªä¸ªç‰ˆæœ¬é‡æ–°å†å‘å¸ƒä¸€éå§ï¼

### å‘äºŒï¼šå°ç‰ˆæœ¬åŒ…å†²çª

è¿™å…¶å®æ˜¯ä¸ªäººç²—å¿ƒå¯¼è‡´çš„ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š`zoo`ä½¿ç”¨å‘½ä»¤`npm i -S @vue2.2.1`å¼•å…¥vueï¼Œ`shop`ä½¿ç”¨å‘½ä»¤`npm i -S @vue2.2.2`å¼•å…¥vueã€‚é‚£ä¹ˆï¼Œé¡¹ç›®ä¼šæœ‰ä¸¤ä¸ªç‰ˆæœ¬çš„`vue`å—ï¼Ÿä¸ä¼šã€‚
åŸå› æˆ‘ä»¬å¯ä»¥çœ‹`zoo`é¡¹ç›®ä¸‹çš„`package.json`ï¼š

```json
"dependencies": {
  "html-webpack-plugin": "^5.5.0",
  "vue": "^2.2.1",
  "webpack": "^5.65.0",
  "webpack-cli": "^4.9.1",
  "webpack-dev-server": "^4.7.2",
  "webpack-merge": "^5.8.0"
}
```

æç„¶å¤§æ‚Ÿã€‚

#### è§£å†³æ–¹æ¡ˆ

-   æ–¹æ¡ˆ1ï¼šå…¶å®å»æ‰`^`å³å¯ï¼›
-   æ–¹æ¡ˆ2ï¼šæˆ‘ä»¬å®‰è£…çš„æ—¶å€™å¯ä»¥ä½¿ç”¨`npm i --save-exact vue@2.2.1 --workspace=zoo`

## æ€»ç»“

æœ¬æ–‡ï¼Œåˆ©ç”¨äº†`workspaces`æ¥åšå¤šåŒ…ç®¡ç†ï¼Œä»¥åŠå¤šé¡¹ç›®ç®¡ç†ï¼Œä½“ç°å‡ºäº†`workspaces`çš„å¼ºå¤§ã€‚å› ä¸ºæˆ‘ä¸ªäººè´Ÿè´£çš„é¡¹ç›®ä¸€ç›´ä»¥æ¥éƒ½æ˜¯ä½¿ç”¨npmæ¥ç®¡ç†çš„ï¼Œæ‰€ä»¥æƒ³è¦è¿ç§»åˆ°yarnæˆ–è€…pnpmå­˜åœ¨æœªçŸ¥çš„é£é™©ï¼Œè€Œä¸”ï¼Œä¹Ÿå°è¯•è¿‡ï¼Œå› ä¸ºä¸€äº›è€åŒ…yarn2å’Œpnpméƒ½è·‘ä¸èµ·æ¥ã€‚å¯¹äºæ–°çš„é¡¹ç›®ï¼Œä¸ªäººä¹Ÿæ›´æ¨èyarn2æˆ–è€…pnpmè¿›è¡Œç®¡ç†ï¼Œå®ƒä»¬æ¯”npmæ›´åŠ å¼ºå¤§ã€‚